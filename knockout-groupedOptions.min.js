/*!
 * knockout-groupedOptions.js v0.3
 * 
 * Copyright (c) Andrew Jameson, www.supertext.ch
 * Available under the MIT license: http://opensource.org/licenses/MIT
 */
ko.bindingHandlers.groupedOptions={init:function(e,t,r,n){if("select"!==e.tagName.toLowerCase())throw new Error("groupedOptions binding applies only to SELECT elements");for(var o=window,a=e.hasAttribute("multiple"),i=o.ko,l=i.utils;e.firstChild;)i.removeNode(e.firstChild);return l.registerEventHandler(e,"change",function(){var t=l.domData.get(e,"property");if(obsData=[],"undefined"!=typeof t){if(a&&!("push"in t))throw new Error("When a <select> element with the 'multiple' attribute is bound to groupedOptions, the value property must be an array.");if(!a&&"push"in t)throw new Error("When a <select> element is bound with 'groupedOptions' the property may only be an array (or observableArray) if the <select> element has the 'multiple' attribute.");var r=e.getElementsByTagName("option");e:for(var o=0,i=r.length;i>o;o++){var p=r[o];if((p.selected===!0||null!==p.getAttribute("selected"))&&(obsData.push(l.domData.get(p,"data")),!a))break e}0!==obsData.length&&("function"==typeof t?t(a?obsData:obsData[0]):"string"==typeof t&&(n[t]=a?obsData:obsData[0]))}}),{controlsDescendantBindings:!0}},update:function(e,t,r,n){var o,a=window,i=a.document,l=a.ko,p=l.utils,s=e.hasAttribute("multiple"),u=l.unwrap(t()),d=u.groups,f="Label",h="Options",g="Text",c="Value",b=function(){var e=document&&function(){for(var e=3,t=document.createElement("div"),r=t.getElementsByTagName("i");t.innerHTML="<!--[if gt IE "+ ++e+"]><i></i><![endif]-->",r[0];)return e>4?e:void 0}(),t=function(e){for(;e.firstChild;)l.removeNode(e.firstChild)},r=function(e,r){if(t(e),r)for(var n=0,o=r.length;o>n;n++)e.appendChild(r[n])},n=function(t,r){7>e?t.setAttribute("selected",r):t.selected=r};return{emptyDomNode:t,setDomNodeChildren:r,setOptionNodeSelectionState:n}}(),m=function(e,t){return"string"==typeof e&&e.length?e:t};if(Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length>>>0,r=Number(arguments[1])||0;for(r=0>r?Math.ceil(r):Math.floor(r),0>r&&(r+=t);t>r;r++)if(r in this&&this[r]===e)return r;return-1}),Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),"undefined"==typeof d||!d)throw'The "groupedOption" binding requires a "groups" object be specified.';if(o=d.coll,!o)throw'The "groupedOption" binding\'s "groups" object requires that a collection (array or observableArray) be specified.';if("string"==typeof d.label&&d.label.length&&(f=d.label),"object"==typeof d.options){var y=d.options;h=m(y.coll,h),g=m(y.text,g),c=m(y.value,c)}var v=u.value,w=l.unwrap(v);p.domData.set(e,"property",v),p.domData.set(e,"data",n);var D=i.createDocumentFragment();if(u.optionsCaption&&"string"==typeof u.optionsCaption&&u.optionsCaption.length){var A=i.createElement("option");A.innerHTML=u.optionsCaption,A.setAttribute("value",""),D.appendChild(A)}for(var C=p.unwrapObservable(o),E=0,O=C.length;O>E;E++){var N=l.unwrap(C[E]),T=l.unwrap(C[E][h]),L=T.length,S=l.unwrap(N[f]);if(S&&S.length){var j=i.createElement("optgroup");j.setAttribute("label",S),p.domData.set(j,"data",N);for(var k=0;L>k;k++){var x=T[k],H=l.unwrap(x[g]),M=l.unwrap(x[c]),B=i.createElement("option");B.innerHTML=H,M&&M.length&&B.setAttribute("value",M),p.domData.set(B,"data",x),j.appendChild(B)}D.appendChild(j)}}b.emptyDomNode(e),e.appendChild(D);var q=e.getElementsByTagName("option"),W=[];if("undefined"!=typeof w)e:for(var F=0,I=q.length;I>F;F++){var B=q[F],V=p.domData.get(B,"data");if((w===V||Array.isArray(w)&&-1!==w.indexOf(V))&&(W.push(B),!s))break e}for(var F=0,I=W.length;I>F;F++)b.setOptionNodeSelectionState(W[F],!0);return!0}};
